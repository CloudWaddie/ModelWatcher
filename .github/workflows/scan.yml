name: Model Scanner

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Fetch models branch for state
        run: |
          git fetch origin models 2>/dev/null || true
          git checkout -B models origin/models 2>/dev/null || true
          # Restore previous state if exists
          if [ -f latest.json ]; then
            mkdir -p logs
            cp latest.json logs/state.json
          fi
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run model scan
        env:
          WEBHOOK: ${{ secrets.WEBHOOK }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          LOCALAI_API_KEY: ${{ secrets.LOCALAI_API_KEY }}
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          FIREWORKS_API_KEY: ${{ secrets.FIREWORKS_API_KEY }}
          DEEPINFRA_API_KEY: ${{ secrets.DEEPINFRA_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: npm run scan
        
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-logs
          path: logs/
          retention-days: 7
          
      - name: Cleanup old logs
        run: |
          # Clean up logs older than 30 days
          find logs -type f -mtime +30 -delete
          
      - name: Commit results to models branch
        run: |
          # Create a temporary directory for the models branch
          cd $GITHUB_WORKSPACE
          
          # Get current models branch SHA if exists
          MODELS_SHA=$(gh api repos/CloudWaddie/ModelWatcher/branches/models --jq '.commit.sha' 2>/dev/null || echo "")
          
          # Copy scan results
          mkdir -p /tmp/models
          cp logs/state.json /tmp/models/latest.json
          cp logs/scan-*.json /tmp/models/ 2>/dev/null || true
          
          # Use GitHub API to create/update the branch
          cd /tmp/models
          
          # Create blobs for each file
          declare -A FILE_BLOBS
          for file in *.json; do
            [ -f "$file" ] || continue
            BLOB=$(echo "$(cat $file)" | gh api --method POST repos/CloudWaddie/ModelWatcher/git/blobs --field content=@- --field encoding=utf-8 --jq '.sha')
            FILE_BLOBS["$file"]=$BLOB
          done
          
          # Build tree
          TREE_ITEMS=""
          for file in "${!FILE_BLOBS[@]}"; do
            TREE_ITEMS="$TREE_ITEMS {\"path\":\"$file\",\"mode\":\"100644\",\"type\":\"blob\",\"sha\":\"${FILE_BLOBS[$file]}\"},"
          done
          
          [ -z "$TREE_ITEMS" ] && echo "No files to commit" && exit 0
          
          TREE_JSON="[${TREE_ITEMS%,}]"
          TREE_SHA=$(echo "$TREE_JSON" | gh api --method POST repos/CloudWaddie/ModelWatcher/git/trees --field tree=@- --jq '.sha')
          
          # Create commit
          PARENT_FLAG=""
          if [ -n "$MODELS_SHA" ]; then
            PARENT_FLAG=",\"parents\":[\"$MODELS_SHA\"]"
          fi
          
          COMMIT_JSON="{\"message\":\"Update models - $(date -u +'%Y-%m-%d %H:%M UTC')\",\"tree\":\"$TREE_SHA\"$PARENT_FLAG}"
          COMMIT_SHA=$(echo "$COMMIT_JSON" | gh api --method POST repos/CloudWaddie/ModelWatcher/git/commits --field json=@- --jq '.sha')
          
          # Update or create branch ref
          echo "{\"sha\":\"$COMMIT_SHA\",\"force\":true}" | gh api --method PUT repos/CloudWaddie/ModelWatcher/git/refs/heads/models --field json=@- || \
            echo "{\"ref\":\"refs/heads/models\",\"sha\":\"$COMMIT_SHA\"}" | gh api --method POST repos/CloudWaddie/ModelWatcher/git/refs --field json=@-
          
          echo "Updated models branch with latest scan"
